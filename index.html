<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Notes</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        .pane {
            height: 100vh;
            overflow-y: auto;
            padding: 20px;
        }
        #arabic-pane {
            background-color: #f8f5ee;
            direction: rtl;
            font-family: 'Scheherazade New', 'me_quran', 'Lateef', serif;
            font-size: 22px;
            line-height: 2.5;
        }
        #translation-pane {
            background-color: #f0f7ff;
            font-size: 18px;
            line-height: 1.8;
        }
        #notes-pane {
            background-color: #fff;
        }
        .verse {
            margin-bottom: 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .verse:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .verse.selected {
            background-color: rgba(70, 130, 180, 0.2);
            font-weight: bold;
        }
        .verse-number {
            color: #4682b4;
            font-weight: bold;
            margin-left: 5px;
            margin-right: 5px;
        }
        .editor-toolbar {
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 5px 5px 0 0;
            border: 1px solid #ddd;
            border-bottom: none;
        }
        .editor-toolbar button {
            background: none;
            border: none;
            padding: 5px 8px;
            cursor: pointer;
            color: #555;
        }
        .editor-toolbar button:hover {
            color: #000;
            background-color: #e9ecef;
        }
        #notes-editor {
            height: calc(100vh - 160px);
            border: 1px solid #ddd;
            border-radius: 0 0 5px 5px;
            padding: 15px;
            font-family: 'Courier New', Courier, monospace;
            resize: none;
            width: 100%;
        }
        #notes-preview {
            height: calc(100vh - 160px);
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .surah-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4682b4;
        }
        .surah-name {
            font-weight: bold;
            font-size: 24px;
        }
        .resize-handle {
            width: 10px;
            background-color: #e9ecef;
            cursor: col-resize;
            transition: background-color 0.2s;
        }
        .resize-handle:hover {
            background-color: #4682b4;
        }
        .tab-button {
            padding: 8px 15px;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab-button.active {
            border-bottom: 2px solid #4682b4;
            color: #4682b4;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(70, 130, 180, 0.3);
            border-radius: 50%;
            border-top-color: #4682b4;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #surah-selector {
            margin: 10px 0;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            width: 100%;
        }
        .translation-selector {
            max-width: 300px;
            margin: 0 auto 15px auto;
        }
        .retry-btn {
            margin-top: 10px;
            padding: 8px 15px;
            background-color: #4682b4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .retry-btn:hover {
            background-color: #3a6d99;
        }
        #current-surah-info {
            font-weight: bold;
            color: #4682b4;
        }
    </style>
</head>
<body>
    <div class="container-fluid h-100">
        <div class="row h-100">
            <!-- Arabic Pane -->
            <div class="col-md p-0" id="arabic-pane">
                <div class="surah-header">
                    <select id="surah-selector" class="form-select">
                        <option value="">Select Surah...</option>
                        <!-- Surah options will be loaded here -->
                    </select>
                    <div class="surah-name" id="arabic-surah-name"></div>
                    <div class="surah-info" id="arabic-surah-info"></div>
                </div>
                <div id="arabic-text">
                    <div class="text-center py-5">
                        <div class="loading"></div>
                        <p>Select a surah to begin</p>
                    </div>
                </div>
            </div>

            <!-- Resize Handle -->
            <div class="resize-handle" id="resize-handle-1"></div>

            <!-- Translation Pane -->
            <div class="col-md p-0" id="translation-pane">
                <div class="surah-header">
                    <div class="translation-selector">
                        <select id="translation-select" class="form-select">
                            <option value="131">MAS Abdel Haleem (Default)</option>
                            <option value="149">Saheeh International</option>
                            <option value="19">Tafheem-ul-Quran (Urdu)</option>
                            <option value="22">Abdul Majid Daryabadi</option>
                            <option value="85">Mufti Taqi Usmani</option>
                        </select>
                    </div>
                    <div class="surah-name" id="translation-surah-name"></div>
                    <div class="surah-info" id="translation-surah-info"></div>
                </div>
                <div id="translation-text">
                    <div class="text-center py-5">
                        <div class="loading"></div>
                        <p>Translation will appear here</p>
                    </div>
                </div>
            </div>

            <!-- Resize Handle -->
            <div class="resize-handle" id="resize-handle-2"></div>

            <!-- Notes Pane -->
            <div class="col-md p-0" id="notes-pane">
                <div class="p-3">
                    <h4>Notes for <span id="current-surah-info">Select a surah</span></h4>

                    <div class="d-flex mb-3">
                        <button class="tab-button active" data-tab="editor">Editor</button>
                        <button class="tab-button" data-tab="preview">Preview</button>
                    </div>

                    <div class="editor-toolbar">
                        <button title="Bold" data-command="bold"><i class="fas fa-bold"></i></button>
                        <button title="Italic" data-command="italic"><i class="fas fa-italic"></i></button>
                        <button title="Heading" data-command="heading"><i class="fas fa-heading"></i></button>
                        <button title="Quote" data-command="quote"><i class="fas fa-quote-right"></i></button>
                        <button title="Code" data-command="code"><i class="fas fa-code"></i></button>
                        <button title="Link" data-command="link"><i class="fas fa-link"></i></button>
                        <button title="Image" data-command="image"><i class="fas fa-image"></i></button>
                        <button title="List" data-command="unorderedList"><i class="fas fa-list-ul"></i></button>
                        <button title="Numbered List" data-command="orderedList"><i class="fas fa-list-ol"></i></button>
                    </div>

                    <div class="tab-content active" id="editor-tab">
                        <textarea id="notes-editor" placeholder="Write your notes here in Markdown format..."></textarea>
                    </div>

                    <div class="tab-content" id="preview-tab">
                        <div id="notes-preview"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
        // Configure marked and highlight.js
        marked.setOptions({
            breaks: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(lang, code).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // API Configuration
        const API_BASE_URL = 'https://api.quran.com/api/v4';
        const TRANSLATIONS = {
            "131": "MAS Abdel Haleem",
            "149": "Saheeh International",
            "19": "Tafheem-ul-Quran (Urdu)",
            "22": "Abdul Majid Daryabadi",
            "85": "Mufti Taqi Usmani"
        };

        // Core Functions
        function updatePreview() {
            const editor = document.getElementById('notes-editor');
            const preview = document.getElementById('notes-preview');
            if (editor && preview) {
                preview.innerHTML = marked.parse(editor.value);
                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }
        }

        function showLoadingState() {
            const arabicPane = document.getElementById('arabic-text');
            const translationPane = document.getElementById('translation-text');

            if (arabicPane) {
                arabicPane.innerHTML = `
                    <div class="text-center py-5">
                        <div class="loading"></div>
                        <p>Loading...</p>
                    </div>
                `;
            }

            if (translationPane) {
                translationPane.innerHTML = `
                    <div class="text-center py-5">
                        <div class="loading"></div>
                        <p>Loading...</p>
                    </div>
                `;
            }
        }

        function showErrorState(message = 'Error loading data', showRetry = false) {
            const arabicPane = document.getElementById('arabic-text');
            const translationPane = document.getElementById('translation-text');

            if (arabicPane) {
                arabicPane.innerHTML = `
                    <div class="text-center py-5 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <p>${message}</p>
                        ${showRetry ? '<button class="retry-btn" onclick="window.location.reload()">Retry</button>' : ''}
                    </div>
                `;
            }

            if (translationPane) {
                translationPane.innerHTML = `
                    <div class="text-center py-5 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <p>${message}</p>
                    </div>
                `;
            }
        }

        async function loadSurahList() {
            try {
                showLoadingState();
                const response = await fetch(`${API_BASE_URL}/chapters?language=en`);

                if (!response.ok) throw new Error("Failed to fetch surah list");

                const data = await response.json();
                const surahSelector = document.getElementById('surah-selector');
                if (surahSelector) {
                    surahSelector.innerHTML = '<option value="">Select Surah...</option>';

                    data.chapters.forEach(surah => {
                        const option = document.createElement('option');
                        option.value = surah.id;
                        option.textContent = `${surah.id}. ${surah.name_simple} (${surah.translated_name.name})`;
                        surahSelector.appendChild(option);
                    });
                }

            } catch (error) {
                console.error('Error loading surah list:', error);
                showErrorState('Failed to load surah list. Please try again later.', true);
            }
        }

        function loadSurahNotes(surahNumber) {
            const editor = document.getElementById('notes-editor');
            if (editor) {
                editor.value = localStorage.getItem(`surah_notes_${surahNumber}`) || '';
                updatePreview();
            }
            document.getElementById('current-surah-info').textContent = `Surah ${surahNumber}`;
        }

        async function loadSurah(surahNumber) {
            try {
                showLoadingState();

                const translationId = document.getElementById('translation-select').value;

                const [arabicResponse, translationResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/quran/verses/uthmani?chapter_number=${surahNumber}`),
                    fetch(`${API_BASE_URL}/verses/by_chapter/${surahNumber}?translations=${translationId}`)
                ]);

                if (!arabicResponse.ok) throw new Error(`Arabic request failed: ${arabicResponse.status}`);
                if (!translationResponse.ok) throw new Error(`Translation request failed: ${translationResponse.status}`);

                const arabicData = await arabicResponse.json();
                const translationData = await translationResponse.json();

                if (!arabicData.verses) throw new Error("No Arabic verses found");
                if (!translationData.verses) throw new Error("No translation verses found");

                updateSurahUI(surahNumber, arabicData.verses, translationData.verses);
                loadSurahNotes(surahNumber);

            } catch (error) {
                console.error('Error loading surah:', error);
                showErrorState(error.message, true);
            }
        }

        function updateSurahUI(surahNumber, arabicVerses, translationVerses) {
            // Update headers
            document.getElementById('arabic-surah-name').textContent = `سورة ${surahNumber}`;
            document.getElementById('translation-surah-name').textContent = `Surah ${surahNumber}`;
            document.getElementById('arabic-surah-info').textContent = `${arabicVerses.length} verses`;
            document.getElementById('translation-surah-info').textContent = `${translationVerses.length} verses`;

            // Update panes
            const arabicPane = document.getElementById('arabic-text');
            const translationPane = document.getElementById('translation-text');

            if (arabicPane) arabicPane.innerHTML = '';
            if (translationPane) translationPane.innerHTML = '';

            // Add Arabic verses
            if (arabicPane) {
                arabicVerses.forEach((verse) => {
                    const verseNumber = verse.verse_number;
                    const arabicText = verse.text_uthmani || "";

                    const arabicVerse = document.createElement('div');
                    arabicVerse.className = 'verse';
                    arabicVerse.dataset.surah = surahNumber;
                    arabicVerse.dataset.verse = verseNumber;
                    arabicVerse.innerHTML = `${arabicText} <span class="verse-number">${verseNumber}</span>`;
                    arabicPane.appendChild(arabicVerse);
                });
            }

            // Add Translation verses
            if (translationPane) {
                translationVerses.forEach((verse) => {
                    const verseNumber = verse.verse_number;
                    const translationText = verse.translations[0].text;

                    const translationVerse = document.createElement('div');
                    translationVerse.className = 'verse';
                    translationVerse.dataset.surah = surahNumber;
                    translationVerse.dataset.verse = verseNumber;
                    translationVerse.innerHTML = `${translationText} <span class="verse-number">${verseNumber}</span>`;
                    translationPane.appendChild(translationVerse);
                });
            }
        }

        function setupVerseSelection() {
            const arabicPane = document.getElementById('arabic-text');
            const translationPane = document.getElementById('translation-text');

            if (arabicPane) {
                arabicPane.addEventListener('click', function(e) {
                    const verseElement = e.target.closest('.verse');
                    if (verseElement) {
                        document.querySelectorAll('.verse').forEach(el => {
                            el.classList.remove('selected');
                        });
                        verseElement.classList.add('selected');
                    }
                });
            }

            if (translationPane) {
                translationPane.addEventListener('click', function(e) {
                    const verseElement = e.target.closest('.verse');
                    if (verseElement) {
                        document.querySelectorAll('.verse').forEach(el => {
                            el.classList.remove('selected');
                        });
                        verseElement.classList.add('selected');
                    }
                });
            }
        }

        function setupMarkdownEditor() {
            const editor = document.getElementById('notes-editor');
            const toolbarButtons = document.querySelectorAll('.editor-toolbar button');

            if (editor) {
                editor.addEventListener('input', function() {
                    const surahSelector = document.getElementById('surah-selector');
                    if (surahSelector.value) {
                        localStorage.setItem(`surah_notes_${surahSelector.value}`, this.value);
                    }
                    updatePreview();
                });
            }

            if (toolbarButtons) {
                toolbarButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const command = this.dataset.command;
                        insertMarkdownCommand(command);
                    });
                });
            }

            function insertMarkdownCommand(command) {
                const editor = document.getElementById('notes-editor');
                if (!editor) return;

                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                const selectedText = editor.value.substring(start, end);
                let newText = '';

                switch(command) {
                    case 'bold': newText = `**${selectedText}**`; break;
                    case 'italic': newText = `*${selectedText}*`; break;
                    case 'heading': newText = `# ${selectedText}`; break;
                    case 'quote': newText = `> ${selectedText}`; break;
                    case 'code': newText = `\`${selectedText}\``; break;
                    case 'link': newText = `[${selectedText}](url)`; break;
                    case 'image': newText = `![alt text](${selectedText})`; break;
                    case 'unorderedList': newText = `- ${selectedText}`; break;
                    case 'orderedList': newText = `1. ${selectedText}`; break;
                    default: return;
                }

                editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);

                const newCursorPos = command === 'link' || command === 'image'
                    ? start + newText.length - 1
                    : start + newText.length;

                editor.setSelectionRange(newCursorPos, newCursorPos);
                editor.focus();
                updatePreview();
            }
        }

        function setupResizeHandles() {
            const resizeHandle1 = document.getElementById('resize-handle-1');
            const resizeHandle2 = document.getElementById('resize-handle-2');
            const arabicPane = document.getElementById('arabic-pane');
            const translationPane = document.getElementById('translation-pane');
            const notesPane = document.getElementById('notes-pane');

            if (!resizeHandle1 || !resizeHandle2 || !arabicPane || !translationPane || !notesPane) return;

            let isResizing1 = false;
            let isResizing2 = false;

            resizeHandle1.addEventListener('mousedown', function(e) {
                isResizing1 = true;
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });

            resizeHandle2.addEventListener('mousedown', function(e) {
                isResizing2 = true;
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing1 && !isResizing2) return;

                const containerWidth = document.querySelector('.container-fluid').offsetWidth;

                if (isResizing1) {
                    const arabicWidth = (e.clientX / containerWidth) * 100;
                    if (arabicWidth > 20 && arabicWidth < 50) {
                        arabicPane.style.flex = `0 0 ${arabicWidth}%`;
                        translationPane.style.flex = `0 0 ${100 - arabicWidth - 6}%`;
                    }
                }

                if (isResizing2) {
                    const translationWidth = ((e.clientX - arabicPane.offsetWidth - resizeHandle1.offsetWidth) / containerWidth) * 100;
                    if (translationWidth > 20 && translationWidth < 50) {
                        translationPane.style.flex = `0 0 ${translationWidth}%`;
                        notesPane.style.flex = `0 0 ${100 - translationWidth - arabicPane.offsetWidth / containerWidth * 100 - 6}%`;
                    }
                }
            });

            document.addEventListener('mouseup', function() {
                isResizing1 = false;
                isResizing2 = false;
                document.body.style.cursor = '';
            });
        }

        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

                    this.classList.add('active');
                    const tabId = this.dataset.tab + '-tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Load surah list and setup UI
            loadSurahList();
            setupVerseSelection();
            setupMarkdownEditor();
            setupResizeHandles();
            setupTabs();

            // Set up event listeners
            document.getElementById('surah-selector').addEventListener('change', function() {
                const surahNumber = this.value;
                if (surahNumber) loadSurah(surahNumber);
            });

            document.getElementById('translation-select').addEventListener('change', function() {
                const surahSelector = document.getElementById('surah-selector');
                if (surahSelector.value) {
                    loadSurah(surahSelector.value);
                }
            });

            // Load saved translation preference
            const savedTranslation = localStorage.getItem('preferredTranslation');
            if (savedTranslation) {
                document.getElementById('translation-select').value = savedTranslation;
            }

            // Save translation preference when changed
            document.getElementById('translation-select').addEventListener('change', function() {
                localStorage.setItem('preferredTranslation', this.value);
            });
        });
    </script>
</body>
</html>